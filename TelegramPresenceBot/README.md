# Telegram Bot для определения присутствия в Sprut.Hub

Этот бот отслеживает присутствие членов семьи с помощью iPhone, Sprut.Hub и Telegram. При входе в радиус геопозиции бот отправляет в группу сообщение, например, “Вася дома”, а при выходе — “Вася не дома”. Система использует геолокацию iPhone и управляется через Telegram Bot API.

## Что потребуется

- iPhone с приложением «Команды» (Shortcuts).
- Телефон с установленным Telegram.
- Sprut.Hub.
- Навыки базовой настройки и копирования-вставки.

-----

## Настройка (шаг за шагом)

### 1. Создание ботов, канала и группы в Telegram

Для работы системы необходимы два бота, приватный канал и группа. Канал принимает команды от iPhone, группа отображает уведомления и служит для обсуждений.

#### Создание основного бота

1. В Telegram найдите @BotFather.
2. Отправьте команду `/newbot`.
3. Укажите имя бота, например, “MyFamilyBot”, и username, заканчивающийся на “Bot”, например, @MyFamilyBot.
4. Сохраните токен, выданный @BotFather (например, `1234567890:ABCDEF...`).
5. В глобальном сценарии найдите строку `let token = '***твой_токен***';` и замените `***твой_токен***` на полученный токен.

#### Создание прокси-бота

1. Повторите шаги с @BotFather, создав второго бота, например, @ProxyFamilyBot.
2. Сохраните его токен для настройки автоматизации на iPhone.

#### Создание канала

1. В Telegram нажмите на три полоски → «Создать канал».
2. Назовите канал, например, “ProxyFamily”, и сделайте его **приватным**.
3. Добавьте обоих ботов (@MyFamilyBot и @ProxyFamilyBot) как администраторов:
- Нажмите на название канала → «Администраторы» → «Добавить администратора».
- Разрешите ботам отправлять сообщения.

#### Создание группы

1. Нажмите на три полоски → «Создать группу».
2. Назовите группу, например, “Семья”, и добавьте обоих ботов.
3. Свяжите группу с каналом:
- В настройках канала выберите «Обсуждение» → укажите группу “Семья”.
- Сообщения из канала будут дублироваться в группу, а бот отправит уведомления в группу.

#### Получение ID канала и группы

1. Добавьте в канал и группу бота @RawDataBot.
2. Напишите любое сообщение (например, “Тест”).
3. @RawDataBot отправит ответ с `chat_id` (например, `-1001234567890` для канала и `-1000987654321` для группы).
4. В глобальном сценарии:
- Найдите строку `let sourceChatID = '***твой_ид_канала***';` и замените `-1001234567890` на ID канала.
- Найдите строку `let replyChatIDs = ['***твой_ид_группы***'];` и замените `-1000987654321` на ID группы.
5. Сохраните ID канала для настройки автоматизации на iPhone.

-----

### 2. Создание виртуальных устройств в Sprut.Hub

Для каждого члена семьи (например, Вася, Лена) создайте виртуальное устройство с выключателем и датчиком присутствия.

1. В Sprut.Hub перейдите в «Устройства».
2. Нажмите «+» → «Добавить виртуальное устройство».
3. Укажите имя устройства (например, Вася).
4. Добавьте два сервиса:
- **Виртуальный выключатель**:
  - Тип: “Switch”.
  - Запишите `accessoryId` (например, `179`).
- **Виртуальный датчик присутствия**:
  - Тип: “Occupancy Sensor”.
5. Повторите для каждого члена семьи.

#### Синхронизация выключателя и датчика

Чтобы датчик показывал «Есть присутствие» при включении выключателя:

1. В настройках датчика выберите «Связь с устройством».
2. В «Обнаружение присутствия» нажмите «Добавить».
3. Выберите выключатель (сервис “Switch”) того же человека.
4. Установите тип синхронизации: «Последнее значение».
5. Сохраните.
6. Скройте выключатель в интерфейсе Sprut.Hub.
7. Повторите для всех членов семьи.

-----

### 3. Настройка сценариев в Sprut.Hub

Система использует глобальный сценарий для обработки сообщений и два блочных сценария: один для запуска и перезапуска бота каждые 12 минут, другой для контроля активности каждые 20 минут.

#### Настройка глобального сценария

1. Скачайте файл TelegramPresenceBot(global).json
2. Перейдите в «Сценарии», раздел "Глобальные".
3. Нажмите «+» → «Импортировать шаблон».
4. Выберите файл глобального сценария.
5. Обновите настройки:
- В строке `let sourceChatID = '***твой_ид_канала***';` вставьте ID канала.
- В строке `let replyChatIDs = ['***твой_ид_группы***'];` вставьте ID группы.
- В строке `let token = '***твой_токен***';` вставьте токен @MyFamilyBot.
- В секции `const switchMap = { ... };` добавьте имена и ID выключателей:
  
  ```javascript
  const switchMap = {
      'Вася': { accessoryId: 179 },
      'Лена': { accessoryId: 180 },
      'Толя': { accessoryId: 181 },
      'Галя': { accessoryId: 182 }
  };
  ```
  - Замените имена и `accessoryId` на ваши.
6. Сохраните сценарий.
7. **Важно**: В настройках глобального сценария **выключите ползунок «Запускать на старте системы»**. Сценарий будет запускаться через блочные сценарии.

#### Настройка блочного сценария TelegramPresence_12min

1. В «Сценарии» нажмите «+» → «Создать блочный сценарий».
2. Назовите сценарий “TelegramPresence_контроль”.
3. В блоке «Если»:
- Выберите «Добавить Планировщик» → «Каждые 12 минут».
4. Добавьте в блок «Тогда» следующий код:
   
   ```javascript
   // Блочный сценарий: TelegramPresence_12min
   // Вызывает global.restartTg каждые 12 минут для перезапуска бота.
   // Триггер: каждые 12 минут (настраивается в интерфейсе Sprut.Hub).
   // Зачем: обновляет состояние, предотвращает зависания, сохраняет данные.
   // Можно менять: интервал триггера (например, 10 минут).
   // Нельзя менять: вызов global.restartTg и логику сброса.

   // Пропускаем ручной запуск через WEB[RPC]
   if (typeof TriggerSource !== 'undefined' && TriggerSource === 'WEB[RPC]') {
       log.info("Manual trigger via WEB[RPC] detected, skipping restart at " + new Date().toISOString());
       return;
   }
   // Сохраняем переменные
   let savedLogId = GlobalVariables.logId || 0;
   let savedOffset = GlobalVariables.__tg_offset || 0;
   let savedProcessedUpdates = GlobalVariables.processedUpdates || {};
   let savedLastActive = GlobalVariables.tg_last_active || 0;
   // Сбрасываем
   GlobalVariables = {};
   // Восстанавливаем
   GlobalVariables.logId = savedLogId;
   GlobalVariables.__tg_offset = savedOffset;
   GlobalVariables.processedUpdates = savedProcessedUpdates;
   GlobalVariables.tg_last_active = savedLastActive;
   // Запускаем
   global.restartTg();
   // Лог: Отображает вызов перезапуска с временем. Зачем: Подтверждает выполнение триггера.
   log.info("global.restartTg called at " + new Date().toISOString()); 
   ```

5. Ниже 1 созданного условного блока, нажмите на «+» → «Добавить условный блок».
6. В блоке «Если»:
- Выберите «Добавить Планировщик» → «Каждые 20 минут».
7. Добавьте в блок «Тогда» следующий код:
   
   ```javascript
   // Блочный сценарий: TelegramPresence_Control_20min
   // Проверяет активность каждые 20 минут с дополнительной задержкой.
   // Зачем: перезапускает tgWatch, если нет активности более 5 минут (дополнительная защита).
   // Можно менять: порог отсутствия активности (например, 300 секунд на 600 секунд для 10 минут) или задержку.
   // Нельзя менять: логику проверки и вызов global.tgWatch.

   // Задержка 6 минут (360000 мс) для избегания пересечений с TelegramPresence_12min
   // Можно менять: установите другое значение, например, 300000 для 5 минут или 60000 для 1 минуты
   setTimeout(function() {
       // Лог: Отображает проверку активности с временем. Зачем: Подтверждает запуск проверки.
       log.info("Checking tgWatch activity at " + new Date().toISOString()); 
       if (GlobalVariables.tg_last_active) {
           let now = Math.floor(Date.now() / 1000);
           if (now - GlobalVariables.tg_last_active > 300) {
               // Лог: Отображает сброс при отсутствии активности. Зачем: Указывает на проблему. 
               log.warn("No activity for 5 minutes, resetting at " + new Date().toISOString()); 
               let savedLogId = GlobalVariables.logId || 0;
               let savedOffset = GlobalVariables.__tg_offset || 0;
               let savedProcessedUpdates = GlobalVariables.processedUpdates || {};
               let savedLastActive = GlobalVariables.tg_last_active || 0;
               GlobalVariables = {};
               GlobalVariables.logId = savedLogId;
               GlobalVariables.__tg_offset = savedOffset;
               GlobalVariables.processedUpdates = savedProcessedUpdates;
               GlobalVariables.tg_last_active = savedLastActive;
               global.tgWatch();
               // Лог: Отображает перезапуск после сброса. Зачем: Подтверждает восстановление. 
               log.info("global.tgWatch called after reset at " + new Date().toISOString()); 
           } else {
               // Лог: Отображает нормальную активность. Зачем: Подтверждает стабильность. 
               log.info("tgWatch is active, no action needed at " + new Date().toISOString()); 
           }
       } else {
           // Лог: Отображает отсутствие необходимости сброса. Зачем: Информирует о состоянии.
           log.info("No reset needed: tg_last_active fresh or recently reset at " + new Date().toISOString()); 
       }
   }, 360000);
   ```
8. Сохраните и активируйте сценарий.
9. **Важно**: В настройках сценария **включите ползунок «Запускать на старте системы»**.

#### Задержки

Сценарий игнорирует сообщения старше 10 минут. Для настройки:

- В глобальном сценарии найдите:
  
  ```javascript
  if (messageTime < startTime || (now - messageTime) > 600)
  ```
- Число `600` (10 минут) можно изменить, например, на `300` (5 минут) для более строгой фильтрации.
- До внесения изменений в коде выполните мягкую или полную остановку (см. ниже).

**Важно**: До внесения любых изменений в коде, сначала нужно деактивировать блочные сценарии TelegramPresence_контроль и выполнить мягкий или полный сброс (см. ниже).

-----

### 4. Мягкая остановка сценария

**Когда использовать мягкую остановку?** Используйте её для небольших изменений, таких как обновление текста уведомлений (например, с “дома” на “пришёл”) или добавление/удаление пользователей в `switchMap`, когда не требуется полный сброс данных.

1. Создайте блочный сценарий “Мягкая остановка TelegramPresenceBot”.
2. Нажмите на «+» → «Добавить блок кода».
3. Добавьте следующий код:
   
   ```javascript
   GlobalVariables.tg_loop_running = false;
   if (GlobalVariables.tg_loop) clearInterval(GlobalVariables.tg_loop);
   GlobalVariables.tg_lock = false;
   log.info("State reset completed.");
   ```
4. Запустите сценарий вручную.
5. Внесите изменения в глобальный сценарий и сохраните.
5. Активируйте блочный сценарий TelegramPresence_контроль, он перезапустит систему в течение 12 или 20 минут соответственно.
7. **Важно**: После выполнения мягкой остановки деактивируйте этот сценарий и в его настройках выключите ползунок «Запускать на старте системы».

-----

### 5. Полный сброс и остановка сценария

**Когда использовать полный сброс?** Используйте его для значительных изменений кода, таких как замена токена, обновление структуры `switchMap` с удалением старых данных или исправление ошибок в логике. Полный сброс очищает все переменные, кроме сохранённых `logId` и `processedUpdates`.

1. Создайте блочный сценарий “Полный сброс TelegramPresenceBot”.
2. Нажмите на «+» → «Добавить блок кода».
3. Добавьте следующий код:
   
   ```javascript
   if (GlobalVariables.tg_loop) {
       log.info("Stopping existing tg_loop timer at " + new Date().toISOString());
       clearInterval(GlobalVariables.tg_loop);
       GlobalVariables.tg_loop = null;
       GlobalVariables.tg_loop_running = false;
   } else {
       log.info("No existing tg_loop timer found at " + new Date().toISOString());
       GlobalVariables.tg_loop_running = false;
   }
   let savedLogId = GlobalVariables.logId || 0;
   let savedProcessedUpdates = GlobalVariables.processedUpdates || {};
   GlobalVariables = {};
   GlobalVariables.logId = savedLogId;
   GlobalVariables.processedUpdates = savedProcessedUpdates;
   log.info("Global variables reset at " + new Date().toISOString());
   log.info("Ready for code replacement, please update the script now.");
   ```
4. Запустите сценарий вручную.
5. Внесите изменения в глобальный сценарий и сохраните.
6. Активируйте блочный сценарий TelegramPresence_контроль, он перезапустит систему в течение 12 или 20 минут соответственно.
7. **Важно**: После выполнения полного сброса деактивируйте этот сценарий и в его настройках выключите ползунок «Запускать на старте системы».

-----

### 6. Одноразовый ручной запуск

**Когда это может быть нужно?** Используйте одноразовый ручной запуск, если нужно немедленно проверить работу бота после внесения изменений, при сбоях цикла (например, после зависания) или для тестирования без ожидания триггеров (12 или 20 минут).

1. Создайте блочный сценарий “Одноразовый запуск TelegramPresenceBot”.
2. Нажмите на «+» → «Добавить блок кода».
3. Добавьте следующий код:
   
   ```javascript
   // Выполняет ручной запуск цикла tgWatch для немедленного начала работы.
   // Использование: Вызывается вручную через WEB[RPC] или другой триггер для перезапуска цикла.
   // Лог: Подтверждает ручной запуск tgWatch с указанием времени. Зачем: Указывает на успешный старт цикла по запросу пользователя.
   if (typeof TriggerSource !== 'undefined' && TriggerSource === 'WEB[RPC]') {
       log.info("Manual trigger via WEB[RPC] detected, skipping manual start at " + new Date().toISOString());
       return;
   }
   global.tgWatch();
   log.info("Manually started tgWatch at " + new Date().toISOString());
   ```
4. Запустите сценарий вручную через кнопку "PLAY".
5. **Важно**: После выполнения ручного запуска деактивируйте этот сценарий и в его настройках выключите ползунок «Запускать на старте системы».

-----

### 7. Настройка автоматизации на iPhone

Настройте iPhone для отправки команд в Telegram по геолокации.

#### Автоматизация «Прибытие домой»

1. В приложении «Команды» (Shortcuts) выберите «Автоматизация» → «+» → «Создать автоматизацию для себя».
2. Выберите «Прибытие», укажите адрес дома и радиус (например, 100 метров).
3. Добавьте действие «Получить содержимое URL»:
- Метод: GET.
- URL:
  
  ```
  https://api.telegram.org/bot***твой_токен_второго_бота***/sendMessage?chat_id=***твой_ид_канала***&text=***закодированное_имя_пользователя***%20arrived
  ```
  - Замените `***твой_токен_второго_бота***` на токен @ProxyFamilyBot.
  - Замените `***твой_ид_канала***` на ID канала.
  - Для `***закодированное_имя_пользователя***`: 
    - На [urlencoder.org](https://www.urlencoder.org/) введите имя (например, Вася ) .
    - Нажмите «Encode» и скопируйте результат (например, `%D0%92%D0%B0%D1%81%D1%8F`) - это закодированное имя "Вася" в кодировке UTF-8.
4. Сохраните, отключив «Спрашивать перед запуском».

#### Автоматизация «Покидание дома»

1. Повторите шаги, выбрав «Покидание».
2. Укажите тот же адрес и радиус.
3. Настройте действие «Получить содержимое URL»:
   
   ```
   https://api.telegram.org/bot***твой_токен_второго_бота***/sendMessage?chat_id=***твой_ид_канала***&text=***закодированное_имя_пользователя***%20left
   ```
4. Сохраните, отключив «Спрашивать перед запуском».

#### Для каждого члена семьи

Создайте автоматизации для каждого человека на его iPhone, заменяя закодированное имя (например, `%D0%9B%D0%B5%D0%BD%D0%B0` для Лена).

-----

### 8. Добавление и удаление пользователей

#### Добавление пользователя (например, Олег):

1. В Sprut.Hub создайте устройство для Олега (см. шаг 2).
2. Деактивируйте блочный сценарий TelegramPresence_контроль.
3. Выполните мягкую остановку сценария.
4. В глобальном сценарии `switchMap` добавьте:
   
   ```javascript
   'Олег': { accessoryId: 183 }
   ```
5. Активируйте блочный сценарий TelegramPresence_контроль, он перезапустит систему в течение 12 или 20 минут соответственно.
6. На iPhone настройте автоматизации с закодированным именем Олега.

#### Удаление пользователя:

1. В `switchMap` удалите строку с именем (например, `'Толя': { accessoryId: 181 }`).
2. Удалите автоматизации на iPhone.
3. Выполните мягкую остановку и перезапустите систему через блочные сценарии.

-----

### 9. Изменение ответов бота

Для изменения текста (например, “пришёл” вместо “дома”):

1. Деактивируйте блочный сценарий TelegramPresence_контроль.
2. Выполните мягкую остановку сценария.
3. В глобальном сценарии замените:
   
   ```javascript
   tg().line(name + " дома").send();
   tg().line(name + " не дома").send();
   ```
   
   на:
   
   ```javascript
   tg().line(name + " пришёл").send();
   tg().line(name + " ушёл").send();
   ```
4. Активируйте блочный сценарий TelegramPresence_контроль, он перезапустит систему в течение 12 или 20 минут соответственно.

-----

### 10. Тестирование

1. Вручную запустите автоматизацию на iPhone.
2. Проверьте:
- Сообщение в канале и группе (например, Вася arrived”).
- Уведомление бота в группе (Вася дома” или Вася не дома”).
- Состояние выключателя в Sprut.Hub.
- Датчик присутствия.
3. Вручную включите/выключите выключатель и проверьте синхронизацию датчика.

-----

### 11. Устранение неполадок

- **Бот не отправляет сообщения**:
  - Проверьте токен, `sourceChatID` и `replyChatIDs`.
  - Убедитесь, что боты — администраторы канала и группы.
- **Автоматизация на iPhone не работает**:
  - Включите геолокацию и уведомления для «Команд».
  - Проверьте радиус (например, 100 метров).
- **Выключатель и датчик не синхронизируются**:
  - Проверьте «Связь с устройством» в Sprut.Hub.
- **Сценарий не запускается**:
  - Убедитесь, что блочный сценарий TelegramPresence_контроль активен.
