# Резервная проверка Восхода - Заката (при старте хаба)

## Основная функция
- Резервный расчет времени восхода/заката по координатам
- Автоматическое определение режима день/ночь при запуске системы
- Управление виртуальным выключателем день/ночь
- Учет высоты над уровнем моря для повышенной точности

## Компоненты системы
1. **Глобальный сценарий** - выполняет астрономические расчеты
2. **Блочный сценарий** - управляет устройствами на основе расчетов

## Настройки

### Глобальные параметры (обязательные)
```javascript
global.LAT = 55.60;     // Широта вашего местоположения
global.LNG = 37.52;     // Долгота 
global.TZ = 3;          // Часовой пояс (UTC+3 для Москвы)
global.ELEVATION = 150; // Высота над уровнем моря (метры)
```

### Параметры блочного сценария
```javascript
var SWITCH_ID = 130;    // ID виртуального выключателя
var CHAR_ID = 15;       // ID характеристики On/Off
```

## Как установить

### 1. **Импортируйте глобальный сценарий**:
   
   1. Перейдите в "Сценарии" → "Глобальные" → "Импортировать шаблон"
   2. Загрузите файл `(глобальный) Восход - Закат (по координатам формулой расчёта).json`
   3. Обновите координаты в конфигурации:
   - `global.LAT`
   - `global.LNG`
   - `global.TZ`
   - `global.ELEVATION`
   4. Сохрани и включи сценарий (нажми на кнопку "Play").

### 2. **Добавьте блочный сценарий**:

   1. Создайте новый блочный сценарий
   2. Добавить блок кода
   3. В параметрах сценария включите ползунок "Выполнить на старте хаба"
   4. Вставьте код этот код:

```javascript
// Конфигурация
var SWITCH_ID = 8;     // Замените на ID вашего выключателя
var CHAR_ID = 15;      // Замените на ID характеристики On/Off

// Получаем данные о солнце
var sunData = global.calculateSunTimes();
var isDayTime = sunData.isDayTime();

// Управляем выключателем
try {
    Hub.setCharacteristicValue(SWITCH_ID, CHAR_ID, isDayTime ? 1 : 0);
    log.info(
        (isDayTime ? "☀️ ДЕНЬ " : "🌙 НОЧЬ ") +
        "| Состояние: " + (isDayTime ? "ВКЛ" : "ВЫКЛ") +
        " | Восход: " + sunData.sunrise + 
        " | Закат: " + sunData.sunset
    );
} catch(e) {
    log.error("Ошибка управления: " + e);
    // Аварийное значение (днём = ВКЛ, ночью = ВЫКЛ)
    var defaultState = (new Date().getHours() >= 6 && new Date().getHours() < 18);
    Hub.setCharacteristicValue(SWITCH_ID, CHAR_ID, defaultState ? 1 : 0);
}
```

   5. Укажите реальные `SWITCH_ID` и `CHAR_ID`
   6. Сохрани и включи сценарий (нажми на кнопку "Play").

## Как проверить работу
1. **Тест расчетов**:
   ```javascript
   global.testSunCalc(); // Покажет в логах:
   // "Восход 06:45:00, Закат 18:30:00, Сейчас ☀️ День"
   ```

2. **Проверка устройства**:
   - После запуска проверьте состояние выключателя
   - В логах должно быть:
   ```
   ☀️ ДЕНЬ | Состояние: ВКЛ | Восход: 06:45:00 | Закат: 18:30:00
   ```

## Аварийные режимы
- При ошибках расчета автоматически используется режим:
  - День: 6:00-18:00
  - Ночь: 18:00-6:00
- Все ошибки записываются в лог системы

## Советы
- Для точности укажите реальные координаты (можно найти в Google Maps)
- Высоту местности проверьте на [FreeMapTools](https://www.freemaptools.com/elevation-finder.htm)
- Для управления несколькими устройствами добавьте их ID в массив:
  ```javascript
  var devices = [
      { switchId: 130, charId: 15 }, // Основной свет
      { switchId: 131, charId: 15 }  // Дополнительный свет
  ];
  ```

## Пример работы
```
[12:00] Запуск системы...
[12:00] Тест расчета: Восход 06:45:00, Закат 18:30:00
[12:00] ☀️ ДЕНЬ | Состояние: ВКЛ | Восход: 06:45:00 | Закат: 18:30:00
[18:31] 🌙 НОЧЬ | Состояние: ВЫКЛ | Восход: 06:45:00 | Закат: 18:30:00
```
